define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Universal Uploader: initialising"),{config:null,init:function(a,b){this.config=b,this.insert_controls(a)},insert_controls:function(b){var c='<div id="'+this.config.widgetid+'_progress" class="p_progress x"><p></p></div>';c+='<div id="'+this.config.widgetid+'_messages" class="p_messages x"></div>',a(b).append(c)},uploadBlob:function(a,b){this.uploadFile(a,b)},extractFilename:function(a){var b="success<filename>",c=a.indexOf(b);if(1>c)return!1;var d=a.indexOf("</filename>"),e=a.substring(c+b.length,d);return e},createProgressBar:function(b,c){var d=!1,e=a("#"+c.config.widgetid+"_progress");if(e.length){var f=e.get(0);d=f.firstChild,null==d&&(d=f.appendChild(document.createElement("p"))),d.className="",d.style.display="block",d.style.backgroundPosition="100% 0",b.upload.addEventListener("progress",function(a){var b=parseInt(100-a.loaded/a.total*100);d.style.backgroundPosition=b+"% 0"},!1)}return d},fetchFileExtension:function(a){var b="";switch(a){case"image/jpeg":b="jpg";break;case"image/png":b="png";break;case"audio/wav":b="wav";break;case"video/quicktime":b="mov";break;case"audio/mpeg3":b="mp3";break;case"audio/webm":b="webm";break;case"audio/x-mpeg-3":b="mp3";break;case"audio/mpeg3":b="mp3";break;case"audio/3gpp":b="3gpp";break;case"video/mpeg3":b="3gpp";break;case"video/mp4":b="mp4";break;case"video/webm":b="webm"}return b},pokeFilename:function(c,d){d.Output(M.util.get_string("recui_uploadsuccess","filter_poodll"));var e=a("#"+d.config.updatecontrol);if(e.length>0)e.get(0).value=c;else{if(e=window.parent.document.getElementById(d.config.updatecontrol),!e)return b.debug("upload failed #2"),b.debug(xhr),d.Output(M.util.get_string("recui_uploaderror","filter_poodll")),!1;e.value=c}return!0},postProcessUpload:function(a,c){var d=a.currentTarget;if(4==d.readyState)if(200==d.status){var e=c.config.filename;if(e||(e=c.extractFilename(d.responseText)),!e)return b.debug("upload failed #1"),void b.debug(d);if(c.config.callbackjs&&""!=c.config.callbackjs){var f=new Array;f[0]=c.config.widgetid,f[1]="filesubmitted",f[2]=e,f[3]=c.config.updatecontrol,this.Output(M.util.get_string("recui_uploadsuccess","filter_poodll")),this.executeFunctionByName(c.config.callbackjs,window,f)}else c.pokeFilename(e,c)}else b.debug("upload failed #3"),b.debug(d),c.Output(M.util.get_string("recui_uploaderror","filter_poodll"))},uploadFile:function(a,b){var c=new XMLHttpRequest,d=this.config,e=this,f=this.fetchFileExtension(b),g=d.using_s3;this.createProgressBar(c,e);if(this.Output(M.util.get_string("recui_uploading","filter_poodll")),c.upload.addEventListener("load",function(){g&&e.postprocess_s3_upload(e)}),c.onreadystatechange=function(a){e.postProcessUpload(a,e)},g)c.open("put",d.posturl,!0),c.setRequestHeader("Content-Type","application/octet-stream"),c.send(a);else{var h="datatype=uploadfile";h+="&paramone="+encodeURIComponent(a),h+="&paramtwo="+f,h+="&paramthree="+d.mediatype,h+="&requestid="+d.widgetid,h+="&contextid="+d.p2,h+="&component="+d.p3,h+="&filearea="+d.p4,h+="&itemid="+d.p5,c.open("POST",d.posturl,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.setRequestHeader("Content-length",h.length),c.setRequestHeader("Connection","close"),c.send(h)}},postprocess_s3_upload:function(a){var b=a.config,c=new XMLHttpRequest,d="datatype=handles3upload";d+="&contextid="+b.p2,d+="&component="+b.p3,d+="&filearea="+b.p4,d+="&itemid="+b.p5,d+="&filename="+b.filename,d+="&mediatype="+b.mediatype,c.open("POST",M.cfg.wwwroot+"/filter/poodll/poodllfilelib.php",!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.setRequestHeader("Content-length",d.length),c.setRequestHeader("Connection","close"),c.send(d)},Output:function(b){var c=a("#"+this.config.widgetid+"_messages");c.text(b)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)}}});