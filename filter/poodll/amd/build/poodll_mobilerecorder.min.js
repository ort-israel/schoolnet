define(["jquery","core/log","filter_poodll/uploader","filter_poodll/poodll_uploadrecorder"],function(a,b,c,d){"use strict";return b.debug("PoodLL Mobile Recorder: initialising"),{supports_current_browser:function(a){var b=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return b},embed:function(a,b){switch(this.config=b,this.linkid="filter_poodll_mobilerecorder_link_"+b.widgetid,b.mediatype){case"audio":this.insert_upload_button(a,this.linkid),this.insert_audio_button(a,this.linkid);break;case"video":this.insert_upload_button(a,this.linkid),this.insert_video_button(a,this.linkid)}return c.init(a,b),this.register_events(a),!0},register_events:function(b){var e=this.config,f=this;a("#"+this.linkid).on("mousedown touchstart",function(a){f.confirm_s3_arrival(),c.Output(M.util.get_string("recui_awaitingconfirmation","filter_poodll"))}),a("#"+this.linkid+"_uploadafile").on("mousedown touchstart",function(c){a(b).empty(),d.embed(b,e)})},insert_video_button:function(b){var c='<a class ="filter_poodll_mobilerecorderlink" id="'+this.linkid+'" href="poodll:record?filename='+this.config.s3filename+"&type="+this.config.mediatype+"&quality="+this.config.mobilequality+"&camera="+this.config.mobilecamera+"&s3folder=&timelimit="+this.config.timelimit+'">'+M.util.get_string("recui_openrecorderapp","filter_poodll")+"</a>";a(b).prepend(c)},insert_audio_button:function(b){var c='<a class ="filter_poodll_mobilerecorderlink"  id="'+this.linkid+'" href="poodll:record?filename='+this.config.s3filename+"&type="+this.config.mediatype+"&quality="+this.config.mobilequality+"&camera="+this.config.mobilecamera+"&s3folder=&timelimit="+this.config.timelimit+'">'+M.util.get_string("recui_openrecorderapp","filter_poodll")+"</a>";a(b).prepend(c)},insert_upload_button:function(b){var c='<a class ="filter_poodll_uploadafilelink" id="'+this.linkid+'_uploadafile" href="#">'+M.util.get_string("recui_uploadafile","filter_poodll")+"</a>";a(b).prepend(c)},confirm_s3_arrival:function(){var a=new XMLHttpRequest,b=this.config,d=b.wwwroot+"/filter/poodll/poodllfilelib.php",e="datatype=confirmarrival";e+="&mediatype="+b.mediatype,e+="&filename="+b.filename,a.open("POST",d,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.setRequestHeader("Cache-Control","no-cache"),a.setRequestHeader("Content-length",e.length),a.setRequestHeader("Connection","close"),a.addEventListener("load",function(){a.response&&a.response.indexOf(b.filename)>0?(c.pokeFilename(b.filename,c),c.postprocess_s3_upload(c),c.Output(M.util.get_string("recui_uploadsuccess","filter_poodll"))):setTimeout(function(){a.open("POST",d,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.setRequestHeader("Cache-Control","no-cache"),a.setRequestHeader("Content-length",e.length),a.setRequestHeader("Connection","close"),a.send(e)},2e3)}),a.send(e)}}});